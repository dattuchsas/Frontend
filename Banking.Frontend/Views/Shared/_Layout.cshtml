@using Banking.Framework
@using Microsoft.AspNetCore.Http
@model Banking.Models.BaseModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor httpContextAccessor
@{
    ISession session = httpContextAccessor.HttpContext?.Session ?? null!;
    string userName = Conversions.ToString(session.GetString(SessionConstants.UserId));
    string appDate = Conversions.ToString(session.GetString(SessionConstants.ApplicationDate));
    string branchCode = Conversions.ToString(session.GetString(SessionConstants.BranchCode));
    string branchName = Conversions.ToString(session.GetString(SessionConstants.BranchNarration));
    string controllerName = Conversions.ToString(session.GetString(SessionConstants.ControllerName));
}

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>THE MAHARAJA CO.OP URBAN BANK LTD.</title>

    <link asp-append-version="true" rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link asp-append-version="true" rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap-datepicker.min.css" />

    <link asp-append-version="true" rel="stylesheet" href="~/css/main.css">

    <link asp-append-version="true" rel="preconnect" href="https://fonts.googleapis.com">
    <link asp-append-version="true" rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link asp-append-version="true" rel="preconnect" href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,400..900;1,14..32,400..900&display=swap">
    <link asp-append-version="true" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">


    <script asp-append-version="true" src="~/lib/jquery/dist/jquery.min.js"></script>
    <script asp-append-version="true" src="~/lib/bootstrap/dist/js/bootstrap-datepicker.min.js"></script>
    <script asp-append-version="true" src="~/js/common/base.js"></script>
    <script asp-append-version="true" src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <header class="main-header py-1">
        <div class="container-xxl">
            <div class="d-flex align-items-center flex-wrap">
                <div class="logo-container d-flex align-items-center">
                    <div class="me-2">
                        <img src="~/images/maharaja_logo.svg" alt="Logo" />
                    </div>
                    <div>
                        <h3 class="mb-0">THE MAHARAJA CO.OP URBAN BANK LTD.</h3>
                    </div>
                </div>
                <div class="mt-2 mt-md-0  logout-container d-flex align-items-center fw-bold ms-auto">
                    <div class="me-3 text-end">
                        <div>FinXPro Banking System</div>
                        @appDate
                    </div>
                    @if (!controllerName.Equals(ControllerNames.Login))
                    {
                        <div class="icon">
                            <a class="text-white" asp-controller="Login" asp-action="Logout"><i class="bi bi-box-arrow-right"></i></a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </header>
    <header class="main-nav">
        <nav class="container-xxl navbar navbar-expand-lg py-0">
            <div class="container-fluid">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse d-flex w-100 align-items-center" id="navbarSupportedContent">
                    @if (!controllerName.Equals(ControllerNames.Dashboard) && !controllerName.Equals(ControllerNames.Login))
                    {
                        @await Component.InvokeAsync("Menu")
                    }
                    <div id="idleTimerUI" class="text-white ms-auto" style="font-size:14px;">
                            Session timeout in: <span id="uiTimer">05:00</span>
                        </div>
                    </div>
            </div>
        </nav>
    </header>
    @if (!controllerName.Equals(ControllerNames.Login))
    {
        <header class="sub-header mb-3">
            <div class="container-xxl">
                <div class="d-flex align-items-center flex-wrap">
                    <h6 class="mb-0 px-5">Welcome, <span class="primary-color">@userName</span></h6>
                    <h2 class="mb-0 ms-auto mt-2 mt-sm-0 px-5">Branch: @branchName</h2>
                </div>
            </div>
        </header>
    }

    <main class="mb-3">
        <div class="container-xxl">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-warning d-none" role="alert" id="mandatoryFieldsAlert"></div>
                    @RenderBody()
                </div>
            </div>
        </div>
    </main>
    <footer class="py-3">
        <div class="container-xxl">
            <div class="row">
                <div class="col-12">
                    Designed and developed by <strong>SAS</strong>
                </div>
            </div>
        </div>
    </footer>

    <!-- Idle Timeout Modal -->
    <div class="modal fade" id="idleModal" tabindex="-1" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Session Expiring</h5>
                </div>
                <div class="modal-body text-center">
                    <p>
                        You will be logged out in <strong id="countdown">00:30</strong> seconds.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"
            integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y"
            crossorigin="anonymous"></script>

    <script>
        var totalIdleSeconds = 5 * 60;      // 5 minutes
        var warningSeconds = 30;            // show modal at 30 sec left
        var idleSeconds = 0;
        var countdownInterval;

        $(document).ready(function () {
            resetIdleTimer();

            // User activity resets timer
            $(document).on('mousemove keydown click scroll', function () {
                resetIdleTimer();
            });

            // Main timer tick
            setInterval(function () {
                idleSeconds++;
                updateUITimer();

                if (idleSeconds === totalIdleSeconds - warningSeconds) {
                    showWarning();
                }

                if (idleSeconds >= totalIdleSeconds) {
                    logoutUser();
                }
            }, 1000);

            // Stay logged in
            $('#stayLoggedIn').click(function () {
                keepAlive();
            });

            $('.input-group.date').datepicker({
                format: "dd-M-yyyy",
                autoclose: true,
                todayHighlight: true,
                defaultViewDate: { year: new Date().getFullYear(), month: new Date().getMonth() + 1, day: new Date().getDate() }
            });

            document.addEventListener('click', function (e) {
                // Close all first
                document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));

                // If clicked on toggle, open its menu
                const toggle = e.target.closest('.dropdown-toggle');
                if (toggle) {
                    toggle.nextElementSibling.classList.add('show');
                }
            });

        });
    </script>

    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="errorMessage"></div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
